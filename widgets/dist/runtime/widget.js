System.register(["jimu-core","jimu-ui","jimu-arcgis","jimu-core/react"],(function(e,t){var r={},o={},n={},a={};return{setters:[function(e){r.DataSourceComponent=e.DataSourceComponent,r.React=e.React,r.jsx=e.jsx},function(e){o.Button=e.Button,o.TextInput=e.TextInput},function(e){n.JimuMapViewComponent=e.JimuMapViewComponent},function(e){a.useEffect=e.useEffect,a.useRef=e.useRef,a.useState=e.useState}],execute:function(){e((()=>{var e={56:(e,t,r)=>{"use strict";e.exports=function(e){var t=r.nc;t&&e.setAttribute("nonce",t)}},72:e=>{"use strict";var t=[];function r(e){for(var r=-1,o=0;o<t.length;o++)if(t[o].identifier===e){r=o;break}return r}function o(e,o){for(var a={},i=[],s=0;s<e.length;s++){var c=e[s],l=o.base?c[0]+o.base:c[0],u=a[l]||0,d="".concat(l," ").concat(u);a[l]=u+1;var p=r(d),f={css:c[1],media:c[2],sourceMap:c[3],supports:c[4],layer:c[5]};if(-1!==p)t[p].references++,t[p].updater(f);else{var m=n(f,o);o.byIndex=s,t.splice(s,0,{identifier:d,updater:m,references:1})}i.push(d)}return i}function n(e,t){var r=t.domAPI(t);r.update(e);return function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;r.update(e=t)}else r.remove()}}e.exports=function(e,n){var a=o(e=e||[],n=n||{});return function(e){e=e||[];for(var i=0;i<a.length;i++){var s=r(a[i]);t[s].references--}for(var c=o(e,n),l=0;l<a.length;l++){var u=r(a[l]);0===t[u].references&&(t[u].updater(),t.splice(u,1))}a=c}}},113:e=>{"use strict";e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},244:e=>{"use strict";e.exports=r},314:e=>{"use strict";e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var r="",o=void 0!==t[5];return t[4]&&(r+="@supports (".concat(t[4],") {")),t[2]&&(r+="@media ".concat(t[2]," {")),o&&(r+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),r+=e(t),o&&(r+="}"),t[2]&&(r+="}"),t[4]&&(r+="}"),r})).join("")},t.i=function(e,r,o,n,a){"string"==typeof e&&(e=[[null,e,void 0]]);var i={};if(o)for(var s=0;s<this.length;s++){var c=this[s][0];null!=c&&(i[c]=!0)}for(var l=0;l<e.length;l++){var u=[].concat(e[l]);o&&i[u[0]]||(void 0!==a&&(void 0===u[5]||(u[1]="@layer".concat(u[5].length>0?" ".concat(u[5]):""," {").concat(u[1],"}")),u[5]=a),r&&(u[2]?(u[1]="@media ".concat(u[2]," {").concat(u[1],"}"),u[2]=r):u[2]=r),n&&(u[4]?(u[1]="@supports (".concat(u[4],") {").concat(u[1],"}"),u[4]=n):u[4]="".concat(n)),t.push(u))}},t}},321:e=>{"use strict";e.exports=o},540:e=>{"use strict";e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},601:e=>{"use strict";e.exports=function(e){return e[1]}},607:(e,t,r)=>{"use strict";r.d(t,{A:()=>s});var o=r(601),n=r.n(o),a=r(314),i=r.n(a)()(n());i.push([e.id,".widget-chatbot{background-color:#ebf5fd;border-radius:5px;font:1em sans-serif;color:black;max-height:100%}.message-user .message-bubble{background-color:#6ff994;color:#000;border-radius:5px !important;display:inline-block;max-width:75%}.message-bot .message-bubble{background-color:#60e588;color:#000;border-radius:5px !important;display:inline-block;max-width:75%}.chat-messages{overflow-y:auto;max-height:600px;padding:10px;border:1px solid #ccc;border-radius:8px;background-color:#fff;position:relative}@keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}.message-user,.message-bot{animation:fadeIn .3s ease-in-out}",""]);const s=i},659:e=>{"use strict";var t={};e.exports=function(e,r){var o=function(e){if(void 0===t[e]){var r=document.querySelector(e);if(window.HTMLIFrameElement&&r instanceof window.HTMLIFrameElement)try{r=r.contentDocument.head}catch(e){r=null}t[e]=r}return t[e]}(e);if(!o)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");o.appendChild(r)}},686:e=>{"use strict";e.exports=n},825:e=>{"use strict";e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(r){!function(e,t,r){var o="";r.supports&&(o+="@supports (".concat(r.supports,") {")),r.media&&(o+="@media ".concat(r.media," {"));var n=void 0!==r.layer;n&&(o+="@layer".concat(r.layer.length>0?" ".concat(r.layer):""," {")),o+=r.css,n&&(o+="}"),r.media&&(o+="}"),r.supports&&(o+="}");var a=r.sourceMap;a&&"undefined"!=typeof btoa&&(o+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(a))))," */")),t.styleTagTransform(o,e,t.options)}(t,e,r)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},972:e=>{"use strict";e.exports=a}},t={};function i(r){var o=t[r];if(void 0!==o)return o.exports;var n=t[r]={id:r,exports:{}};return e[r](n,n.exports,i),n.exports}i.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return i.d(t,{a:t}),t},i.d=(e,t)=>{for(var r in t)i.o(t,r)&&!i.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.p="",i.nc=void 0;var s={};return i.p=window.jimuConfig.baseUrl,(()=>{"use strict";i.r(s),i.d(s,{__set_webpack_public_path__:()=>E,default:()=>S});var e=i(244),t=i(321),r=i(72),o=i.n(r),n=i(825),a=i.n(n),c=i(659),l=i.n(c),u=i(56),d=i.n(u),p=i(540),f=i.n(p),m=i(113),v=i.n(m),y=i(607),g={};g.styleTagTransform=v(),g.setAttributes=d(),g.insert=l().bind(null,"head"),g.domAPI=a(),g.insertStyleElement=f();o()(y.A,g);y.A&&y.A.locals&&y.A.locals;var h=i(686);const x={FILTER_LAYERS:(e,t)=>{if(!(null==e?void 0:e.view))return void console.error("Vista de mapa no disponible");const r=Object.assign(Object.assign({},{show:[],hide:[]}),t);e.view.map.allLayers.forEach((e=>{e&&e.title&&(r.show.includes(e.title)&&(e.visible=!0,console.log(`Capa '${e.title}' VISIBLE`)),r.hide.includes(e.title)&&(e.visible=!1,console.log(`Capa '${e.title}' OCULTA`)))}))},FILTER_BY_FIELD:(e,t)=>{if(!(null==e?void 0:e.view))return void console.error("Vista de mapa no disponible");const r=Object.assign(Object.assign({},{layerTitle:"Parcelas",fieldName:"Deuda",operator:">",value:0,clear:!1}),t||{}),o=e.view.map.allLayers.find((e=>!(!e||!e.title)&&(e.title===r.layerTitle||e.title.toLowerCase()===(r.layerTitle||"").toLowerCase())));if(!o)return void console.error(`No se encontr\xf3 la capa '${r.layerTitle}'.`);const n="definitionExpression"in o?o:o.featureLayer&&"definitionExpression"in o.featureLayer?o.featureLayer:null;if(!n)return void console.error(`La capa '${o.title}' no soporta definitionExpression. No es una FeatureLayer?`);if(r.clear)return n.definitionExpression="1=1",void console.log(`Filtro limpiado en capa '${n.title}'`);let a,i=r.value;if("string"==typeof i){const e=parseFloat(String(i).replace(/[^0-9.-]+/g,"").replace(",","."));i=isNaN(e)?String(i).replace(/'/g,"''"):e}a="number"==typeof i?`${r.fieldName} ${r.operator} ${i}`:`${r.fieldName} ${r.operator} '${i}'`,n.definitionExpression=a,console.log(`Aplicado filtro en '${n.title}': ${n.definitionExpression}`)}};var b=i(972),w=function(e,t,r,o){return new(r||(r=Promise))((function(n,a){function i(e){try{c(o.next(e))}catch(e){a(e)}}function s(e){try{c(o.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,s)}c((o=o.apply(e,t||[])).next())}))};const S=r=>{var o,n;(null===(o=r.useMapWidgetIds)||void 0===o?void 0:o.length)||console.error("CRITICAL: No hay widget de mapa conectado");const[a,i]=e.React.useState(null),[s,c]=e.React.useState(null),[l,u]=e.React.useState([{sender:"bot",text:"\xa1Hola! Soy tu asistente GIS. \xbfEn qu\xe9 puedo ayudarte?"}]),[d,p]=e.React.useState(""),[f,m]=(0,b.useState)([]),v=(0,b.useRef)(null),y=()=>w(void 0,void 0,void 0,(function*(){if(d.trim()){u((e=>[...e,{sender:"user",text:d}])),p("");try{const e=yield fetch("http://127.0.0.1:8000/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({conversation_id:s,message:{role:"user",content:d}})});if(!e.ok)throw new Error(`Error HTTP: ${e.status}`);const t=yield e.json();c(t.conversation_id),u((e=>[...e,{sender:"bot",text:t.response.text}]));const r=t.response.function;Array.isArray(r)&&r.forEach((e=>((e,t)=>{if(!a)return void console.error("Error: Vista de mapa no disponible");const r=x[e];r?r(a,t):console.error(`Funci\xf3n "${e}" no registrada`)})(e.name,e.params)))}catch(e){console.error("Error en la API:",e),u((e=>[...e,{sender:"bot",text:"\u26a0\ufe0f Error de conexi\xf3n con el servidor"}]))}}})),g=(e,t)=>{const r=e.layer;r&&r.url?m((e=>[...e,{id:r.id,title:r.title,layer:r}])):console.warn("Omitiendo capa sin URL o inaccesible:",(null==r?void 0:r.title)||t)},S=e=>u((t=>[...t,{sender:"bot",text:e}]));return(0,b.useEffect)((()=>{a&&console.log("Contexto para backend:",{layers:f.map((e=>({id:e.id,title:e.title}))),functions:["FILTER_LAYERS","FILTER_BY_FIELD"]})}),[a,f]),(0,b.useEffect)((()=>{const e=v.current;e&&(e.scrollTop=e.scrollHeight)}),[l]),(0,e.jsx)("div",{className:"widget-chatbot d-flex flex-column",style:{height:"100%",padding:"10px"}},(null===(n=r.useMapWidgetIds)||void 0===n?void 0:n[0])&&(0,e.jsx)(h.JimuMapViewComponent,{useMapWidgetId:r.useMapWidgetIds[0],onActiveViewChange:e=>w(void 0,void 0,void 0,(function*(){m([]),i(e);try{yield e.whenAllJimuLayerViewLoaded(),S("\u2705 Mapa cargado y listo para usar")}catch(e){console.error("Error cargando layer views:",e)}}))}),Array.isArray(r.useDataSources)&&r.useDataSources.map((t=>(0,e.jsx)(e.DataSourceComponent,{key:t.dataSourceId,useDataSource:t,widgetId:r.id,onDataSourceCreated:g}))),(0,e.jsx)("div",{ref:v,className:"chat-messages flex-grow-1 my-2 p-2 border rounded"},l.map(((t,r)=>(0,e.jsx)("div",{key:r,className:`message-${t.sender} mb-2`,style:{textAlign:"user"===t.sender?"right":"left",animation:"fadeIn 0.3s"}},(0,e.jsx)("span",{className:"message-bubble p-2 rounded"},t.text))))),(0,e.jsx)("div",{className:"chat-input d-flex"},(0,e.jsx)(t.TextInput,{className:"flex-grow-1 mr-2",placeholder:"Escribe un comando...",value:d,onChange:e=>p(e.target.value),onKeyDown:e=>"Enter"===e.key&&y()}),(0,e.jsx)(t.Button,{icon:!0,onClick:y,disabled:!d.trim()},(0,e.jsx)("svg",{width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16"},(0,e.jsx)("path",{d:"M15.964 7.5l-15-7A1 1 0 0 0 0 1v14a1 1 0 0 0 1.964.5L5.5 11H11a1 1 0 0 0 0-2H5.5L1.964 2.5A1 1 0 0 0 0 3v.268L13.536 8 0 12.732V14a1 1 0 0 0 1.964.5L15.964 8.5a1 1 0 0 0 0-1z"})))))};function E(e){i.p=e}})(),s})())}}}));